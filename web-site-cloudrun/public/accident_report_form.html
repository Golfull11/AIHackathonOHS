<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="admin_title">管理者画面</title>
    <!-- Tailwind CSS と Font Awesome を読み込み -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <!-- i18nextライブラリを読み込み -->
    <script src="https://unpkg.com/i18next/dist/umd/i18next.min.js"></script>
    <style>
        /* index.html と共通のカスタムスタイル */
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .lang-btn.active { background-color: #4f46e5; color: white; font-weight: bold; }
        /* フォーム要素のスタイル */
        .form-group { margin-bottom: 1.5rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151; }
        .form-input { display: block; width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
        .form-input:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2); }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-2xl">
        <div class="bg-white px-6 pb-6 pt-16 sm:px-8 sm:pb-8 sm:pt-16 rounded-lg shadow-xl w-full fade-in relative">
            
            <!-- 言語切り替えボタン -->
            <div class="absolute top-4 right-4 flex space-x-1 sm:space-x-2">
                <button id="ja" class="lang-btn px-2 sm:px-3 py-1 border rounded-md text-xs sm:text-sm hover:bg-gray-100 transition-colors">日本語</button>
                <button id="en" class="lang-btn px-2 sm:px-3 py-1 border rounded-md text-xs sm:text-sm hover:bg-gray-100 transition-colors">English</button>
                <button id="bn" class="lang-btn px-2 sm:px-3 py-1 border rounded-md text-xs sm:text-sm hover:bg-gray-100 transition-colors">বাংলা</button>
                <button id="zh" class="lang-btn px-2 sm:px-3 py-1 border rounded-md text-xs sm:text-sm hover:bg-gray-100 transition-colors">中文</button>
            </div>

            <!-- ログイン画面 (デフォルトで表示) -->
            <div id="login-container">
                <!-- ★★★ ここからが修正部分 ★★★ -->
                <header class="text-center mb-8 relative">
                    <h1 class="text-3xl font-bold text-gray-800 mb-2" data-i18n="login_header"></h1>
                    <div class="absolute top-0 left-0">
                         <a href="index.html" class="text-indigo-600 hover:text-indigo-800 transition-colors">&larr; <span data-i18n="back_to_top"></span></a>
                    </div>
                </header>
                <!-- ★★★ ここまでが修正部分 ★★★ -->
                <main>
                    <div class="form-group">
                        <input type="email" id="login-email" class="form-input text-center" data-i18n="[placeholder]login_email_placeholder">
                    </div>
                    <div class="form-group">
                        <input type="password" id="login-password" class="form-input text-center" data-i18n="[placeholder]login_password_placeholder">
                    </div>
                    <button id="login-button" data-i18n="login_button" class="w-full inline-flex items-center justify-center px-6 py-3 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"></button>
                    <p id="login-error" class="text-red-500 text-center mt-4"></p>
                </main>
            </div>

            <!-- 事故報告フォーム (ログイン後に表示) -->
            <div id="report-container" class="hidden">
                <header class="text-center mb-8 relative">
                    <h1 class="text-3xl font-bold text-gray-800 mb-2" data-i18n="form_title"></h1>
                    <p class="text-md text-gray-500" data-i18n="form_subtitle"></p>
                    <div class="absolute top-0 left-0">
                         <a href="index.html" class="text-indigo-600 hover:text-indigo-800 transition-colors">&larr; <span data-i18n="back_to_top"></span></a>
                    </div>
                </header>
                <main>
                    <div class="text-right mb-4 text-sm">
                        <span id="user-email"></span>
                        <span data-i18n="login_status_text"></span>
                        <button id="logout-button" class="ml-2 font-semibold text-red-500 hover:text-red-700" data-i18n="logout_button"></button>
                    </div>
                    
                    <form id="report-form">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="form-group md:col-span-2">
                                <label for="title" class="form-label" data-i18n="title_label"></label>
                                <input type="text" id="title" class="form-input" required>
                            </div>
                             <div class="form-group md:col-span-2">
                                <label for="occurredAt" class="form-label" data-i18n="occurrence_time_label"></label>
                                <input type="datetime-local" id="occurredAt" class="form-input" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="description" class="form-label" data-i18n="description_label"></label>
                            <textarea id="description" rows="4" class="form-input" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="cause" class="form-label" data-i18n="cause_label"></label>
                            <textarea id="cause" rows="4" class="form-input" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="measures" class="form-label" data-i18n="measures_label"></label>
                            <textarea id="measures" rows="4" class="form-input" required></textarea>
                        </div>
                        <button type="submit" id="submit-report-button" data-i18n="submit_report_button" class="w-full inline-flex items-center justify-center px-6 py-3 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"></button>
                        <p id="submit-status" class="text-center mt-4"></p>
                    </form>
                </main>
            </div>

        </div>
    </div>

    <!-- Firebase SDK (ESM) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- ★★★ 重要 ★★★ ---
        // 以下をご自身のFirebaseプロジェクトの設定に置き換えてください。
        const firebaseConfig = {
            apiKey: "AIzaSyB2mOtPO2msHFI1BLgl1DRNWBgdQq4plNQ",
            authDomain: "safety-recommend-app-2025.firebaseapp.com",
            projectId: "safety-recommend-app-2025",
            storageBucket: "safety-recommend-app-2025.firebasestorage.app",
            messagingSenderId: "467976745475",
            appId: "1:467976745475:web:94739fae6f7bfa83755436",
            measurementId: "G-E15RPNTBE4"
            };
        
        // --- アプリケーションの初期化 ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM要素の取得 ---
        const loginContainer = document.getElementById('login-container');
        const reportContainer = document.getElementById('report-container');
        const loginEmailInput = document.getElementById('login-email');
        const loginPasswordInput = document.getElementById('login-password');
        const loginButton = document.getElementById('login-button');
        const loginError = document.getElementById('login-error');
        const userEmailSpan = document.getElementById('user-email');
        const logoutButton = document.getElementById('logout-button');
        const reportForm = document.getElementById('report-form');
        const submitStatus = document.getElementById('submit-status');

        // --- 翻訳データ ---
        const resources = {
            ja: { translation: { "title": "労働安全ナビゲーター", "subtitle": "作業内容を入力して、潜む危険と対策を確認しましょう。", "search_placeholder": "例：高所で足場を組み立てる作業", "search_button": "検索", "loading_text": "検索中...", "measures_header": "実施すべき対策", "videos_header": "関連動画", "video_title_description": "事故の状況", "video_title_measure": "対策", "gemini_suggestion_header": "Geminiからの追加提案", "generate_doc_button": "この内容で文書を作成", "generate_doc_button_loading": "文書を作成中...", "admin_title": "管理者画面", "login_header": "ログイン", "login_email_placeholder": "メールアドレス", "login_password_placeholder": "パスワード", "login_button": "ログイン", "login_status_text": "でログイン中", "logout_button": "ログアウト", "register_case_header": "社内事例の登録", "occurred_at_label": "発生日時:", "title_label": "タイトル（必須）", "description_label": "どのような状況だったか（必須）", "cause_label": "原因は何か（必須）", "measures_label": "どのような対策を行ったか（必須）", "submit_button": "登録する", "form_title": "事故報告フォーム", "form_subtitle": "以下の項目を入力してください。", "occurrence_time_label": "発生日時", "situation_label": "事故の状況", "cause_label_form": "原因", "countermeasures_label": "考えられる対策", "submit_report_button": "報告を登録する", "error_fetch": "情報の取得に失敗しました。もう一度お試しください。", "error_pdf": "PDFの生成に失敗しました。", "admin_section_title": "管理者向け", "admin_link_text": "事故登録", "back_to_top": "トップに戻る", "submit_success": "報告が正常に登録されました。", "submit_error": "登録に失敗しました。もう一度お試しください。" } },
            en: { translation: { "title": "Safety Navigator", "subtitle": "Enter the work details to check for potential hazards and countermeasures.", "search_placeholder": "e.g., Assembling scaffolding at a high place", "search_button": "Search", "loading_text": "Searching...", "measures_header": "Measures to be Implemented", "videos_header": "Related Videos", "video_title_description": "Accident Situation", "video_title_measure": "Countermeasures", "gemini_suggestion_header": "Additional Suggestions from Gemini", "generate_doc_button": "Create Document with this Content", "generate_doc_button_loading": "Creating document...", "admin_title": "Admin Panel", "login_header": "Login", "login_email_placeholder": "Email Address", "login_password_placeholder": "Password", "login_button": "Login", "login_status_text": "Logged in as", "logout_button": "Logout", "register_case_header": "Register Internal Case", "occurred_at_label": "Date and Time of Occurrence:", "title_label": "Title (Required)", "description_label": "What was the situation? (Required)", "cause_label": "What was the cause? (Required)", "measures_label": "What measures were taken? (Required)", "submit_button": "Submit", "form_title": "Accident Report Form", "form_subtitle": "Please fill in the following items.", "occurrence_time_label": "Time of Occurrence", "situation_label": "Situation of the Accident", "cause_label_form": "Cause", "countermeasures_label": "Possible Countermeasures", "submit_report_button": "Submit Report", "error_fetch": "Failed to fetch information. Please try again.", "error_pdf": "Failed to generate PDF.", "admin_section_title": "For Administrators", "admin_link_text": "Register Accident", "back_to_top": "Back to Top", "submit_success": "Report registered successfully.", "submit_error": "Failed to register. Please try again." } },
            bn: { translation: { "title": "নিরাপত্তা নেভিগেটর", "subtitle": "সম্ভাব্য বিপদ এবং পাল্টা ব্যবস্থা পরীক্ষা করতে কাজের বিবরণ লিখুন।", "search_placeholder": "যেমন, উঁচু স্থানে স্ক্যাফোল্ড একত্রিত করা", "search_button": "অনুসন্ধান", "loading_text": "অনুসন্ধান চলছে...", "measures_header": "বাস্তবায়ন করার জন্য ಕ್ರಮ", "videos_header": "সম্পর্কিত ভিডিও", "video_title_description": "দুর্ঘটনার পরিস্থিতি", "video_title_measure": "পাল্টা ব্যবস্থা", "gemini_suggestion_header": "Gemini থেকে অতিরিক্ত পরামর্শ", "generate_doc_button": "এই বিষয়বস্তু দিয়ে ডকুমেন্ট তৈরি করুন", "generate_doc_button_loading": "ডকুমেন্ট তৈরি হচ্ছে...", "admin_title": "অ্যাডমিন প্যানেল", "login_header": "লগইন", "login_email_placeholder": "ইমেল ঠিকানা", "login_password_placeholder": "পাসওয়ার্ড", "login_button": "লগইন", "login_status_text": " হিসাবে লগ ইন করেছেন", "logout_button": "লগআউট", "register_case_header": "অভ্যন্তরীণ কেস নিবন্ধন করুন", "occurred_at_label": "ঘটনার তারিখ এবং সময়:", "title_label": "শিরোনাম (প্রয়োজনীয়)", "description_label": "পরিস্থিতি কী ছিল? (প্রয়োজনীয়)", "cause_label": "কারণ কী ছিল? (প্রয়োজনীয়)", "measures_label": "কী ব্যবস্থা নেওয়া হয়েছিল? (প্রয়োজনীয়)", "submit_button": "জমা দিন", "form_title": "দুর্ঘটনা প্রতিবেদন ফর্ম", "form_subtitle": "অনুগ্রহ করে নিম্নলিখিত আইটেমগুলি পূরণ করুন।", "occurrence_time_label": "ঘটনার সময়", "situation_label": "দুর্ঘটনার পরিস্থিতি", "cause_label_form": "কারণ", "countermeasures_label": "সম্ভাব্য পাল্টা ব্যবস্থা", "submit_report_button": "প্রতিবেদন জমা দিন", "error_fetch": "তথ্য আনতে ব্যর্থ। অনুগ্রহ করে আবার চেষ্টা করুন।", "error_pdf": "পিডিএফ তৈরি করতে ব্যর্থ হয়েছে।", "admin_section_title": "প্রশাসকদের জন্য", "admin_link_text": "দুর্ঘটনা নিবন্ধন করুন", "back_to_top": "শীর্ষে ফিরে যান", "submit_success": "প্রতিবেদন সফলভাবে নিবন্ধিত হয়েছে।", "submit_error": "নিবন্ধন করতে ব্যর্থ। অনুগ্রহ করে আবার চেষ্টা করুন।" } },
            zh: { translation: { "title": "安全导航员", "subtitle": "输入工作内容以检查潜在危险和对策。", "search_placeholder": "例如：在高处组装脚手架", "search_button": "搜索", "loading_text": "正在搜索...", "measures_header": "应采取的措施", "videos_header": "相关视频", "video_title_description": "事故情况", "video_title_measure": "对策", "gemini_suggestion_header": "来自Gemini的额外建议", "generate_doc_button": "用此内容创建文档", "generate_doc_button_loading": "正在创建文档...", "admin_title": "管理员面板", "login_header": "登录", "login_email_placeholder": "电子邮件地址", "login_password_placeholder": "密码", "login_button": "登录", "login_status_text": "已登录为", "logout_button": "登出", "register_case_header": "登记内部案例", "occurred_at_label": "发生日期和时间：", "title_label": "标题（必填）", "description_label": "当时情况如何？（必填）", "cause_label": "原因是什么？（必填）", "measures_label": "采取了什么措施？（必填）", "submit_button": "提交", "form_title": "事故报告表", "form_subtitle": "请填写以下项目。", "occurrence_time_label": "发生时间", "situation_label": "事故情况", "cause_label_form": "原因", "countermeasures_label": "可能的对策", "submit_report_button": "提交报告", "error_fetch": "获取信息失败。请再试一次。", "error_pdf": "生成PDF失败。", "admin_section_title": "管理员专用", "admin_link_text": "事故登记", "back_to_top": "返回顶部", "submit_success": "报告已成功登记。", "submit_error": "登记失败，请重试。" } }
        };

        // --- UI更新とイベントリスナー設定 ---

        const updateContent = () => {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (key.startsWith('[placeholder]')) {
                    const pKey = key.replace('[placeholder]', '');
                    el.placeholder = i18next.t(pKey);
                } else {
                    el.innerHTML = i18next.t(key);
                }
            });
            document.title = i18next.t('admin_title');
            const currentLang = i18next.language;
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.toggle('active', btn.id === currentLang);
            });
        };

        async function main() {
            await i18next.init({ lng: 'ja', debug: true, resources });

            // 認証状態の監視
            onAuthStateChanged(auth, user => {
                if (user) {
                    // ログイン状態
                    loginContainer.classList.add('hidden');
                    reportContainer.classList.remove('hidden');
                    userEmailSpan.textContent = user.email;
                } else {
                    // ログアウト状態
                    loginContainer.classList.remove('hidden');
                    reportContainer.classList.add('hidden');
                }
                updateContent(); // 画面が表示された後に翻訳を適用
            });
            
            // 言語切り替え
            document.querySelectorAll('.lang-btn').forEach(button => {
                button.addEventListener('click', () => {
                    i18next.changeLanguage(button.id, () => updateContent());
                });
            });

            // ログイン処理
            loginButton.addEventListener('click', async () => {
                const email = loginEmailInput.value;
                const password = loginPasswordInput.value;
                loginError.textContent = '';
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    console.error("Login Error:", error);
                    loginError.textContent = "ログインに失敗しました。";
                }
            });

            // ログアウト処理
            logoutButton.addEventListener('click', () => {
                signOut(auth);
            });

            // フォーム送信処理
            reportForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                submitStatus.textContent = '';
                const submitButton = document.getElementById('submit-report-button');
                submitButton.disabled = true;

                // フォームからデータを取得
                const formData = {
                    title: document.getElementById('title').value,
                    occurredAt: new Date(document.getElementById('occurredAt').value),
                    description: document.getElementById('description').value,
                    cause: document.getElementById('cause').value,
                    measures: document.getElementById('measures').value,
                    createdAt: serverTimestamp() // Firestoreサーバーのタイムスタンプ
                };

                try {
                    const docRef = await addDoc(collection(db, "internal_cases"), formData);
                    console.log("Document written with ID: ", docRef.id);
                    submitStatus.textContent = i18next.t('submit_success');
                    submitStatus.className = 'text-green-600 text-center mt-4';
                    reportForm.reset(); // フォームをリセット
                } catch (error) {
                    console.error("Error adding document: ", error);
                    submitStatus.textContent = i18next.t('submit_error');
                    submitStatus.className = 'text-red-500 text-center mt-4';
                } finally {
                    submitButton.disabled = false;
                }
            });

            // UI初期化
            updateContent();
        }

        main();
    </script>
</body>
</html>