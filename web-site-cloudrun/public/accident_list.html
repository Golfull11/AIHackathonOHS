<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="case_list_title">事故情報一覧</title>
    <!-- Tailwind CSS と Font Awesome を読み込み -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <!-- i18nextライブラリを読み込み -->
    <script src="https://unpkg.com/i18next/dist/umd/i18next.min.js"></script>
    <style>
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .lang-btn.active { background-color: #4f46e5; color: white; font-weight: bold; }
        .form-input { display: block; width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-6xl">
        <div class="bg-white px-6 pb-6 pt-16 sm:px-8 sm:pb-8 sm:pt-16 rounded-lg shadow-xl w-full fade-in relative">
            
            <div class="absolute top-4 right-4 flex space-x-1 sm:space-x-2">
                <button id="ja" class="lang-btn px-2 sm:px-3 py-1 border rounded-md text-xs sm:text-sm hover:bg-gray-100 transition-colors">日本語</button>
                <button id="en" class="lang-btn px-2 sm:px-3 py-1 border rounded-md text-xs sm:text-sm hover:bg-gray-100 transition-colors">English</button>
                <button id="bn" class="lang-btn px-2 sm:px-3 py-1 border rounded-md text-xs sm:text-sm hover:bg-gray-100 transition-colors">বাংলা</button>
                <button id="zh" class="lang-btn px-2 sm:px-3 py-1 border rounded-md text-xs sm:text-sm hover:bg-gray-100 transition-colors">中文</button>
            </div>

            <!-- ログイン画面 -->
            <div id="login-container">
                <header class="text-center mb-8 relative">
                    <h1 class="text-3xl font-bold text-gray-800 mb-2" data-i18n="login_header"></h1>
                    <div class="absolute top-0 left-0">
                         <a href="index.html" class="text-indigo-600 hover:text-indigo-800 transition-colors">&larr; <span data-i18n="back_to_top"></span></a>
                    </div>
                </header>
                <main>
                    <div class="max-w-md mx-auto">
                        <input type="email" id="login-email" class="form-input text-center mb-4" data-i18n="[placeholder]login_email_placeholder">
                        <input type="password" id="login-password" class="form-input text-center mb-4" data-i18n="[placeholder]login_password_placeholder">
                        <button id="login-button" data-i18n="login_button" class="w-full inline-flex items-center justify-center px-6 py-3 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700"></button>
                        <p id="login-error" class="text-red-500 text-center mt-4"></p>
                    </div>
                </main>
            </div>

            <!-- 一覧表示コンテナ (ログイン後に表示) -->
            <div id="list-container" class="hidden">
                <header class="text-center mb-8 relative">
                    <h1 class="text-3xl font-bold text-gray-800 mb-2" data-i18n="case_list_title"></h1>
                    <div class="absolute top-0 left-0">
                        <a href="index.html" class="text-indigo-600 hover:text-indigo-800 transition-colors">&larr; <span data-i18n="back_to_top"></span></a>
                    </div>
                </header>
                <main>
                    <div class="flex justify-between items-center mb-4 text-sm">
                        <div>
                             <a href="accident_report_form.html" class="font-semibold text-indigo-600 hover:text-indigo-800" data-i18n="go_to_form_button"></a>
                        </div>
                        <div class="text-right">
                            <span id="user-email"></span>
                            <span data-i18n="login_status_text"></span>
                            <button id="logout-button" class="ml-2 font-semibold text-red-500 hover:text-red-700" data-i18n="logout_button"></button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="th_occurred_at"></th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="th_title"></th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="th_description"></th>
                                </tr>
                            </thead>
                            <tbody id="cases-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- データはここに動的に挿入されます -->
                            </tbody>
                        </table>
                    </div>
                </main>
            </div>
            <footer class="text-center mt-12 pt-6 border-t border-gray-200">
                <p class="text-xs text-gray-500">&copy; 2025 DXGX consult. All Rights Reserved.</p>
            </footer>
        </div>
    </div>

    <!-- Firebase SDK (ESM) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB2mOtPO2msHFI1BLgl1DRNWBgdQq4plNQ",
            authDomain: "safety-recommend-app-2025.firebaseapp.com",
            projectId: "safety-recommend-app-2025",
            storageBucket: "safety-recommend-app-2025.firebasestorage.app",
            messagingSenderId: "467976745475",
            appId: "1:467976745475:web:94739fae6f7bfa83755436",
            measurementId: "G-E15RPNTBE4"
            };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const loginContainer = document.getElementById('login-container');
        const listContainer = document.getElementById('list-container');
        const loginEmailInput = document.getElementById('login-email');
        const loginPasswordInput = document.getElementById('login-password');
        const loginButton = document.getElementById('login-button');
        const loginError = document.getElementById('login-error');
        const userEmailSpan = document.getElementById('user-email');
        const logoutButton = document.getElementById('logout-button');
        const casesTableBody = document.getElementById('cases-table-body');

        const resources = {
            ja: { translation: { "login_header": "ログイン", "login_email_placeholder": "メールアドレス", "login_password_placeholder": "パスワード", "login_button": "ログイン", "login_status_text": "でログイン中", "logout_button": "ログアウト", "back_to_top": "トップに戻る", "case_list_title": "事故情報一覧", "go_to_form_button": "新規登録フォームへ", "th_occurred_at": "発生日時", "th_title": "タイトル", "th_description": "概要" } },
            en: { translation: { "login_header": "Login", "login_email_placeholder": "Email Address", "login_password_placeholder": "Password", "login_button": "Login", "login_status_text": "Logged in as", "logout_button": "Logout", "back_to_top": "Back to Top", "case_list_title": "Accident Case List", "go_to_form_button": "Go to Registration Form", "th_occurred_at": "Time of Occurrence", "th_title": "Title", "th_description": "Description" } },
            bn: { translation: { "login_header": "লগইন", "login_email_placeholder": "ইমেল ঠিকানা", "login_password_placeholder": "পাসওয়ার্ড", "login_button": "লগইন", "login_status_text": " হিসাবে লগ ইন করেছেন", "logout_button": "লগআউট", "back_to_top": "শীর্ষে ফিরে যান", "case_list_title": "দুর্ঘটনার তালিকা", "go_to_form_button": "নিবন্ধন ফর্মে যান", "th_occurred_at": "ঘটনার সময়", "th_title": "শিরোনাম", "th_description": "বিবরণ" } },
            zh: { translation: { "login_header": "登录", "login_email_placeholder": "电子邮件地址", "login_password_placeholder": "密码", "login_button": "登录", "login_status_text": "已登录为", "logout_button": "登出", "back_to_top": "返回顶部", "case_list_title": "事故信息列表", "go_to_form_button": "前往登记表", "th_occurred_at": "发生时间", "th_title": "标题", "th_description": "概要" } }
        };

        const updateContent = () => {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (key.startsWith('[placeholder]')) {
                    el.placeholder = i18next.t(key.replace('[placeholder]', ''));
                } else {
                    el.innerHTML = i18next.t(key);
                }
            });
            document.title = i18next.t('case_list_title');
            const currentLang = i18next.language;
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.toggle('active', btn.id === currentLang);
            });
        };

        async function main() {
            await i18next.init({ lng: 'ja', debug: true, resources });

            let unsubscribe; // Firestoreのリスナーを解除するための変数

            onAuthStateChanged(auth, user => {
                if (user) {
                    loginContainer.classList.add('hidden');
                    listContainer.classList.remove('hidden');
                    userEmailSpan.textContent = user.email;

                    // ログイン時にFirestoreからデータを取得開始
                    const q = query(collection(db, "internal_cases"), orderBy("createdAt", "desc"));
                    unsubscribe = onSnapshot(q, (querySnapshot) => {
                        casesTableBody.innerHTML = ''; // テーブルをクリア
                        querySnapshot.forEach((doc) => {
                            const data = doc.data();
                            const row = casesTableBody.insertRow();
                            
                            // 日付のフォーマット
                            const occurredAt = data.occurredAt ? data.occurredAt.toDate().toLocaleString('ja-JP') : 'N/A';
                            
                            row.innerHTML = `
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${occurredAt}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${data.title}</td>
                                <td class="px-6 py-4 text-sm text-gray-500 truncate" title="${data.description}">${data.description}</td>
                            `;
                        });
                    });

                } else {
                    loginContainer.classList.remove('hidden');
                    listContainer.classList.add('hidden');
                    if (unsubscribe) unsubscribe(); // ログアウト時にリスナーを解除
                }
                updateContent();
            });
            
            document.querySelectorAll('.lang-btn').forEach(button => {
                button.addEventListener('click', () => {
                    i18next.changeLanguage(button.id, () => updateContent());
                });
            });

            loginButton.addEventListener('click', async () => {
                try {
                    await signInWithEmailAndPassword(auth, loginEmailInput.value, loginPasswordInput.value);
                } catch (error) {
                    loginError.textContent = "ログインに失敗しました。";
                }
            });

            logoutButton.addEventListener('click', () => signOut(auth));
            updateContent();
        }
        main();
    </script>
</body>
</html>